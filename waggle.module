<?php

/**
 *  Implements hook_menu()
 */
function waggle_menu()
{
    $items['stories'] = array(
      'page callback' => 'waggle_stories',
      'access arguments' => array('access content'),
    );
    // API
    $items['waggle/api/load-user'] = array(
      'page callback' => 'waggle_load_user',  
      'type' => MENU_CALLBACK,
      'access callback' => TRUE,
    );
    $items['waggle/api/get-stories'] = array(
      'page callback' => 'waggle_load_stories_default',  
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
    );
    $items['waggle/api/get-stories/%'] = array(
      'page callback' => 'waggle_load_stories',  
      'page arguments' => array(3),
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
    );
    $items['waggle/api/add-note'] = array(
      'page callback' => 'waggle_add_note',  
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
    );

    return $items;
}

function waggle_stories()
{
    drupal_add_js(drupal_get_path('module', 'waggle') . '/js/page-calls.js');
    drupal_add_js(drupal_get_path('module', 'waggle') . '/js/functions.js');
    drupal_add_js(drupal_get_path('module', 'waggle') . '/js/input-controls.js');
    //drupal_add_js(drupal_get_path('module', 'waggle') . '/js/story-dom.js');
    drupal_add_js('
      jQuery(document).ready(function() {
        LoadUser();
        GetTickets();
        PrepareInterface();    
      });
    ', 'inline');

    return 'Loading Stories...';
}


/**
 * Implements hook_block_info()
 */
function waggle_block_info(){
  $blocks['waggle_sidebar'] = array(
    'info' => 'Waggle Sidebar',
	'cache' => DRUPAL_NO_CACHE,
	'status' => 1,
	'region' => 'sidebar_second',
  );
  return $blocks;
}

/**
 * Implements hook_block_view()
 */
function waggle_block_view($delta = ''){
  switch ($delta) {
    case 'waggle_sidebar':
	  $block['subject'] = NULL;
	  $block['content'] = array(
	    '#type' => 'markup',
		'#markup' => '<div id="waggle-sidebar"></div>',
	  );
	  break;
  }
  
  return $block;
}



/*****   API CALLS  ********/

/**
 *   function to load and return the current user
 */
function waggle_load_user(){
  global $user;
  return drupal_json_encode($user);
}

/**
 *  function to load default stories, pass them through the appropriate view, and return the rendered html
 */
function waggle_load_stories_default(){
  //dsm('stories');
  return drupal_json_output(views_embed_view('waggle_stories', 'block'));
}

/**
 *  function to load stories of given nids, pass them through the appropriate view, and return the rendered html
 */
function waggle_load_stories($stories_arg){
  dsm($stories_arg);
  return views_embed_view('waggle_stories', 'page');
}

/**
 * Function to add a note to a given story nid.
 */
function waggle_add_note(){
  $get = $_GET;
  global $user;
  $node = node_load($get['nid']);
  // Return if the given nid is invalid, or belongs to a non-story node, or if the user-provided note is empty, or the user isn't logged in
  if (!$node || $node->type != 'story' || empty($get['note']) || $user->uid == 0) {
    return 'There was an error with your request.  If you continue to receive this message, please email ashelp@uky.edu or call 859-257-1541.';
  }
  
  $new_note = (object) array('type' => 'action');
  node_object_prepare($new_note);
  
  $new_note->title = $get['nid'] . '-' . time();
  $new_note->body['und'][0]['value'] = $get['note'];
  $new_note->field_story['und'][0]['nid'] = $get['nid'];
  node_save($new_note);
  if ($new_note) {
    $node->field_actions['und'][] = array('nid' => $new_note->nid);
	node_save($node);
  }
  drupal_json_output(views_embed_view('waggle_story_actions', 'block', $get['nid']));
  //return 'yes';
}