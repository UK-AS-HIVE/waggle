<?php

/**
 * Implements hook_help().
 */
function waggle_email_help($path, $arg) {
  switch ($path) {
    case 'admin/help#waggle_email':
      return '<p>' . t('Waggle email.') . '</p>';
  }
}

/*
 * Implements hook_cron
 */
function waggle_email_cron()
{
  // TODO: eventually check the imap server for incoming messages, but
  // first make sure it _works_ and second make sure hook_cron is the right place
  // for this... sometimes the process is long-running, so it may not be

  //waggle_email_collect_imap_messages();
}

/*
 * Implements hook_menu().
 */
function waggle_email_menu()
{
  $items = array();
  $items['admin/config/waggle_email'] = array(
    'title' => 'Waggle Email',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('waggle_email_admin_form'),
    'access arguments' => array('administer site configuration'), 
    'file' => 'waggle_email.admin.inc',
  );
  $items['admin/config/waggle_email/imap_credentials'] = array(
    'title' => 'IMAP Credentials',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('waggle_email_admin_form'),
    'access arguments' => array('administer site configuration'), 
    'file' => 'waggle_email.admin.inc',
  );

  return $items;
}

function waggle_email_admin_form_validate($form, $form_state)
{
}

function waggle_email_admin_form_submit($form, &$form_state)
{
  $server = $form_state['values']['server'];
  $user = $form_state['values']['user'];
  $pass = $form_state['values']['pass'];
  $secure = $form_state['values']['secure'];
  variable_set('waggle_email_imap_server', $server);
  variable_set('waggle_email_imap_user', $user);
  variable_set('waggle_email_imap_pass', $pass);
  variable_set('waggle_email_imap_secure', $secure);
}


function waggle_email_node_insert($node) {
  if ($node->type === 'story') {
    global $user;
    $user = user_load($user->uid);
    $uids = array_unique(array_merge(
      array($node->uid),
      array_map(function($o) { return $o['uid']; }, $node->field_associated_users['und'])
    ));
    $recipients = user_load_multiple($uids);
    $address_list = implode(',', array_map(function ($r) { return $r->name . ' <' . $r->mail . '>'; }, $recipients));
    drupal_mail('waggle_email', 'new_story', $address_list, $node->language,
      array(
        '!nid' => $node->nid,
        '!author' => $recipients[$node->uid]->name,
        '!body' => $node->body['und'][0]['value'],
        '!from_story' => true,
      ),
      $recipients[$node->uid]->mail, TRUE);
  }  
}


function waggle_email_comment_insert($comment) {
  $node = node_load($comment->nid);
  if ($node->type === 'story') {
    global $user;
    $account = user_load($user->uid);
    $uids = array_unique(array_merge(
      array($node->uid),
      array_map(function($o) { return $o['uid']; }, $node->field_associated_users['und'])
    ));

    // Remove the user submitting the comment from the recipient array if needed.
    // TODO: can't remove him if it's the story submitter, or we need a new way to get the story submitter's name for !original_author below
    /*if (in_array($user->uid, $uids)) {
      unset($uids[array_search($user->uid, $uids)]);
    }*/


    $recipients = user_load_multiple($uids);
    $address_list = implode(',', array_map(function ($r) {
      $mail = $r->field_mail['und'][0]['value'];
      if (empty($mail)) $mail = $r->mail;
      return $r->name . ' <' . $mail . '>';
    }, $recipients));
    drupal_mail('waggle_email', 'new_note', $address_list, $node->language,
      array(
        '!nid' => $node->nid,
        '!author' => $account->name,
        '!body' => $comment->comment_body['und'][0]['value'],
        '!original_body' => $node->body['und'][0]['value'],
        '!original_author' => $recipients[$node->uid]->name,
        '!from_story' => true,
      ),
      $account->mail, TRUE);
  }  
 
}

/**
 * Implements hook_mail().
 *
 * Defines the actual subjects and messages to be delivered.
 */
function waggle_email_mail($key, &$message, $params) {
  switch ($key) {
    case 'new_story':
      $message['subject'] = t('Story# !nid', $params);
      $message['body'][] = t('<b>A new story has been opened by !author:</b><br/>!body<br/>'
        . '<br/>Visit <a href="https://help.as.uky.edu/story-search?ws=id:!nid+status:any">'
	. 'the story</a> to respond.',
        $params);
      break;
    case 'new_note':
      $message['subject'] = t('Re: Story# !nid', $params);
      $message['body'][] = t(
        '<b>!author left a new note on your story:</b><br/>!body<br/><br/>'
        . '<br/><b>!original_author\'s original story was:</b><br/>!original_body<br/>'
        . '<br/>Visit <a href="https://help.as.uky.edu/story-search?ws=id:!nid+status:any">'
	. 'the story</a> to respond.',
        $params);
      break;
  }
}

/**
 * Implements hook_mail_alter()
 *
 * sets the sender and reply-to address as story-#######@domain.com
 *
 */
function waggle_email_mail_alter(&$message) {
  if ($message['params']['!from_story'] == true){
    global $base_root;
    $fromNode = $message['params']['!nid'];
    $thisDomain = str_replace(array('http://', 'https://'), '', $base_root);
    $replyTo = 'story-' . $fromNode . "@" . $thisDomain;
    $message['headers']['Reply-To'] = $replyTo;
    $message['headers']['Sender'] = $replyTo;
  }
}


